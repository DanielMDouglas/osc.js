<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>OscProb.js</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <style type="text/css">
    .overlay {
      fill: none;
      pointer-events: all;
    }
  </style>

  <!-- MathJax -->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>

  <!-- d3.js -->
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <!-- Local code -->
  <script src="prob3.js"></script>
  <script src="OscProbConstraints.js"></script>
  <script src="OscProbPlot.js"></script>

  <script type="text/javascript">

        var bp = new BargerPropagator();
        var op = new OscParams();

        function AddCurve(plot, params, is_tmp) {

          let nufrom = GetProb3NuTypeFromPDG(params.from_pdg);
          let nuto = GetProb3NuTypeFromPDG(params.to_pdg);
          if((nufrom === 0)||(nuto === 0)){
            return;
          }

          bp.SetMNS(params.S2Th12,params.S2Th13,params.S2Th23,params.Dm2_21,params.Dm2_Atm,params.dcp, 1, true, 1);

          let osc_curve = {
            meta : {id : 0, name : "osc_curve" },
            data : []
          };

          let EMin = 0;
          let EMax = 5;
          let ESteps = 1000;

          let EStep = (EMax-EMin)/ESteps;

          let baseline = 1300;

          for(let i = 0; i < ESteps; ++i){
            let p = [];
            p[0] = EMin + i*EStep;
            bp.SetEnergy(p[0]);
            bp.propagateLinear(1,baseline, 3.3);
            p[1] = bp.GetProb(nufrom, nuto);
            if(!isNaN(p[1])){
              osc_curve.data.push(p);
            }
          }

          if(is_tmp){
            plot.AddTmp(osc_curve);
          } else {
            plot.AddCurve(osc_curve);
          }

        }

        function OscProbInit(){

          let op_el = document.getElementById("OscProbPlot");
          var op_plot = new OscProbPlot();
          op_plot.DrawAxes(op_el);

          document.getElementById("add_btn").onclick =
            function(){AddCurve(op_plot, op, false);};
          document.getElementById("clear_btn").onclick =
            function(){op_plot.ClearAll();};

          let cc = document.getElementById("ConstraintControls");
          var ce = new ConstraintElements();
          ce.Initialize(cc, function(changed_params) {
            console.log(changed_params);
            Object.keys(changed_params).forEach(function(param) {
              op.Set(param, changed_params[param]);
            });
            AddCurve(op_plot,op,true);
          }
          );

        }
        window.onload = OscProbInit;


  </script>

</head>

<body>

  <div class="container-fluid">
    <div class="row">
      <div id="OscProbPlot" class="col-12" />
    </div>
    <div class="row">
      <div id="ConstraintControls" class="col-12" />
    </div>
    <div class="row">
      <input id="add_btn" type="button" value="Add" />
      <input id="clear_btn" type="button" value="Clear" />
    </div>
  </div>
</body>
</html>
